#!/usr/bin/env bash

billing()
{

    aws ce get-cost-and-usage \
        --time-period  Start=${1},End=${2} \
        --granularity=$3 \
        --metrics BlendedCost UnblendedCost UsageQuantity \
        --output text
}

help()
{
    echo "Usage: billing-aws [-dm <MONTH>][-h]"
    echo "          -d DAILY"
    echo "          -m MONTHLY"
}


while getopts dhm:y: OPTION
do
    if [[ -z $OPTION ]]
    then
        echo "Argument required"
        exit 1
    fi
    case $OPTION in
        d)
            GRANULARITY=DAILY
            ;;
        h)
            help
            ;;
        m)
            MONTH=$(printf %02d $OPTARG)
            GRANULARITY=MONTHLY
            ;;
        y)
            YEAR=$(printf %04d $OPTARG)
            ;;
        *)
            exit 1
            ;;
    esac
done

if [[ "$GRANULARITY" = "DAILY" ]]
then
    START=$(gdate +%Y-%m-%d -d "1 day ago")
    END=$(gdate +%Y-%m-%d)
else
    YEAR=${YEAR:-$(gdate +%Y)}
    START=$(gdate +${YEAR}-${MONTH}-01)
    END=$(gdate -d "$START 1 month" +%Y-%m-%d)
fi

billing $START $END $GRANULARITY
